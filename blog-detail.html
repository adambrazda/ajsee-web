<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title data-i18n-key="blog-detail-title">Blog | AJSEE®</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="/src/styles/main.scss">
  <link rel="icon" href="/images/logo-ajsee.png">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-K0ZS0D9JLK"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-K0ZS0D9JLK');
  </script>
</head>
<body>
<header class="site-header">
  <!-- ... stejný header jako jinde ... -->
</header>

<main>
  <section class="blog-detail">
    <div class="container">
      <a href="/blog.html?lang=cs" class="back-link" data-i18n-key="blog-back">← Zpět na blog</a>

      <article id="blogArticle">
        <!-- Zde dynamicky vkládáme článek podle JS -->
      </article>

      <!-- COMMENTS: begin (Netlify Forms – registrace při buildu) -->
      <section class="comments" id="comments">
        <h3 class="comments-title" data-i18n-key="comments.title">Komentáře</h3>

        <form
          id="commentForm"
          name="site-comments"
          method="POST"
          data-netlify="true"
          data-netlify-recaptcha="true"
          netlify-honeypot="bot-field"
        >
          <!-- Netlify potřebuje form-name -->
          <input type="hidden" name="form-name" value="site-comments" />
          <!-- Hidden pole pro identifikaci příspěvku a jazyk -->
          <input type="hidden" name="postId" id="commentPostId" value="" />
          <input type="hidden" name="postType" id="commentPostType" value="blog" />
          <input type="hidden" name="lang" id="commentLang" value="" />

          <!-- Honeypot (skryté, boty to vyplní) -->
          <p class="hp" hidden>
            <label>Don’t fill this out: <input name="bot-field" /></label>
          </p>

          <div class="comments-grid">
            <div class="form-row">
              <label for="c_name" data-i18n-key="comments.name">Jméno</label>
              <input id="c_name" name="name" type="text" required autocomplete="name"
                     placeholder="Tvoje jméno" data-i18n-placeholder="comments.namePh" />
            </div>

            <div class="form-row">
              <label for="c_email" data-i18n-key="comments.email">E-mail</label>
              <input id="c_email" name="email" type="email" required autocomplete="email"
                     placeholder="tvuj@email.cz" data-i18n-placeholder="comments.emailPh" />
              <small class="hint" data-i18n-key="comments.emailHint">E-mail se nezobrazuje veřejně.</small>
            </div>

            <div class="form-row">
              <label for="c_website" data-i18n-key="comments.website">Web (nepovinné)</label>
              <input id="c_website" name="website" type="url"
                     placeholder="https://tvoje-stranka.cz" data-i18n-placeholder="comments.websitePh" />
              <small class="hint" data-i18n-key="comments.websiteHint">Web se veřejně nezobrazuje.</small>
            </div>

            <div class="form-row form-row--full">
              <label for="c_comment" data-i18n-key="comments.comment">Komentář</label>
              <textarea id="c_comment" name="comment" rows="5" required
                        placeholder="Napiš svůj komentář…" data-i18n-placeholder="comments.commentPh"></textarea>
            </div>

            <!-- reCAPTCHA placeholder – Netlify ji sem vloží -->
            <div data-netlify-recaptcha="true"></div>

            <div class="form-actions">
              <button type="submit" class="btn-primary" data-i18n-key="comments.submit">Odeslat komentář</button>
              <p class="form-status" id="commentStatus" aria-live="polite"></p>
            </div>
          </div>
        </form>

        <!-- sem budeme renderovat komentáře z Netlify Functions -->
        <div id="commentsList" class="comments-list" aria-live="polite"></div>
      </section>
      <!-- COMMENTS: end -->
    </div>
  </section>
</main>

<footer>
  <!-- ... footer ... -->
</footer>

<script type="module" src="/src/main.js"></script>
<script type="module" src="/src/blog-detail.js"></script>

<!-- Inline init pro komentáře: nastaví lang/postId/postType, načte a odesílá -->
<script>
  (function () {
    // Jazyk z URL nebo z <html lang>
    const qs = new URLSearchParams(location.search);
    const lang =
      (qs.get('lang') || document.documentElement.getAttribute('lang') || 'cs')
        .toLowerCase().split(/[-_]/)[0];
    document.getElementById('commentLang').value = lang;

    // Identifikace příspěvku: ?id=..., fallback pathname
    let postType = 'blog';
    let postId = qs.get('id') || location.pathname;
    document.getElementById('commentPostType').value = postType;
    document.getElementById('commentPostId').value = postId;

    const statusEl = document.getElementById('commentStatus');
    const listEl = document.getElementById('commentsList');

    const escape = (s='') =>
      String(s)
        .replace(/&/g, '&amp;').replace(/</g, '&lt;')
        .replace(/>/g, '&gt;').replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

    function fmtDate(iso) {
      try {
        const d = new Date(iso);
        return d.toLocaleString(lang, { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
      } catch { return iso; }
    }

    function renderComments(items) {
      if (!Array.isArray(items) || !items.length) {
        listEl.innerHTML = '<p class="comments-empty" data-i18n-key="comments.empty">Zatím žádné komentáře.</p>';
        return;
      }
      listEl.innerHTML = items.map(it => `
        <article class="comment-item" data-id="${escape(it.id)}">
          <header class="comment-head">
            <strong class="comment-author">${escape(it.name || 'Anonym')}</strong>
            <time class="comment-date" datetime="${escape(it.createdAt)}">${escape(fmtDate(it.createdAt))}</time>
          </header>
          <div class="comment-body"><p>${escape(it.comment).replace(/\n{2,}/g, '</p><p>').replace(/\n/g, '<br>')}</p></div>
        </article>
      `).join('');
    }

    async function loadComments() {
      try {
        const url = new URL('/.netlify/functions/get-comments', location.origin);
        url.searchParams.set('postId', postId);
        url.searchParams.set('postType', postType);
        url.searchParams.set('lang', lang);
        const r = await fetch(url.toString(), { headers: { 'Accept': 'application/json' } });
        const data = await r.json();
        renderComments(data.items || []);
      } catch (e) {
        listEl.innerHTML = '<p class="comments-error">Komentáře nelze načíst.</p>';
      }
    }

    // Načíst hned po otevření
    loadComments();

    // Odeslání (stále kompatibilní s Netlify Forms)
    const form = document.getElementById('commentForm');
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      const fd = new FormData(form);
      if (!fd.get('form-name')) fd.set('form-name', 'site-comments');

      fetch('/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams(fd).toString()
      })
      .then(() => {
        statusEl.textContent = (lang === 'cs') ? 'Díky! Komentář byl odeslán.' : 'Thanks! Your comment was submitted.';
        form.reset();
        // refresh výpisu po ~1s (Netlify zpracuje submission)
        setTimeout(loadComments, 1200);
      })
      .catch(() => {
        statusEl.textContent = (lang === 'cs') ? 'Odeslání se nepodařilo.' : 'Submission failed.';
      });
    }, { passive: false });
  })();
</script>
</body>
</html>
