<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title data-i18n-key="blog-detail-title">Blog | AJSEE®</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <meta name="theme-color" content="#0077cc" />
  <link rel="icon" href="/images/logo-ajsee.png">

  <!-- Prémiové fonty -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Kill-switch pro paralelní renderery + Impact tracking konfigurace -->
  <script>
    window.__TM_INLINE_DISABLED = true;
    window.__impact = window.__impact || { param: 'irclickid', value: '<SET_YOUR_CLICK_ID>' };
  </script>

  <!-- Google tag – pouze na HTTPS/produkci -->
  <script>
    (function(){
      const isProdHttps = location.protocol === 'https:' && !/localhost|127\.0\.0\.1|0\.0\.0\.0/i.test(location.hostname);
      if (!isProdHttps) return;
      const s = document.createElement('script');
      s.async = true;
      s.src = 'https://www.googletagmanager.com/gtag/js?id=G-K0ZS0D9JLK';
      s.onload = function(){
        window.dataLayer = window.dataLayer || [];
        function gtag(){ dataLayer.push(arguments); }
        window.gtag = gtag;
        gtag('js', new Date());
        gtag('config', 'G-K0ZS0D9JLK');
      };
      document.head.appendChild(s);
    })();
  </script>

  <!-- i18n fallback – jen když hlavní engine ještě nedodal překlady -->
  <script>
    (function(){
      function detectLang(){
        try {
          const qs = new URLSearchParams(location.search);
          return (qs.get('lang') || document.documentElement.lang || 'cs').toLowerCase();
        } catch { return 'cs'; }
      }

      function applyI18nFallback(lang){
        const root = window.translations || null;
        if (!root) return;

        const dict = root[lang] || root;
        const get = (path) => path.split('.').reduce((o,k)=>o?.[k], dict);

        document.querySelectorAll('[data-i18n-key]').forEach(el => {
          const key = el.getAttribute('data-i18n-key');
          const val = get(key);
          if (typeof val === 'string' && val.trim()) el.textContent = val;
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
          const key = el.getAttribute('data-i18n-placeholder');
          const val = get(key);
          if (typeof val === 'string' && val.trim()) el.setAttribute('placeholder', val);
        });
        document.querySelectorAll('[data-i18n-aria]').forEach(el => {
          const key = el.getAttribute('data-i18n-aria');
          const val = get(key);
          if (typeof val === 'string' && val.trim()) {
            el.setAttribute('aria-label', val);
            el.setAttribute('title', val);
          }
        });
        document.querySelectorAll('[data-i18n-alt]').forEach(el => {
          const key = el.getAttribute('data-i18n-alt');
          const val = get(key);
          if (typeof val === 'string' && val.trim()) el.setAttribute('alt', val);
        });
      }

      window.addEventListener('DOMContentLoaded', () => {
        const lang = detectLang();
        document.documentElement.lang = lang;

        // Pokud už main bundle poskytl applyTranslations, fallback nespouštěj.
        if (typeof window.applyTranslations === 'function') return;

        setTimeout(() => {
          if (typeof window.applyTranslations === 'function') return;
          applyI18nFallback(lang);
        }, 250);
      });
    })();
  </script>

  <!-- ✅ PROD BUILD (Vite) – jediný vstup + CSS -->
  <!-- POZOR: hashe musí odpovídat tvému aktuálnímu buildu -->
  <script type="module" crossorigin src="/assets/main-DSzsxf2X.js"></script>
  <link rel="stylesheet" crossorigin href="/assets/main-DMl0tCYI.css">
</head>

<body data-page="blog-detail">
<header class="site-header">
  <!-- Pokud už máš jednotný header řešený přes main.js,
       tady nechávám placeholder jak jsi měl. -->
  <!-- ... stejný header jako jinde ... -->
</header>

<main>
  <section class="blog-detail">
    <div class="container">
      <a href="/blog.html?lang=cs" class="back-link" data-i18n-key="blog-back">← Zpět na blog</a>

      <article id="blogArticle">
        <!-- Zde dynamicky vkládáme článek podle JS -->
      </article>

      <!-- COMMENTS: begin (Netlify Forms – registrace při buildu) -->
      <section class="comments" id="comments">
        <h3 class="comments-title" data-i18n-key="comments.title">Komentáře</h3>

        <form
          id="commentForm"
          name="site-comments"
          method="POST"
          data-netlify="true"
          data-netlify-recaptcha="true"
          netlify-honeypot="bot-field"
        >
          <input type="hidden" name="form-name" value="site-comments" />
          <input type="hidden" name="postId" id="commentPostId" value="" />
          <input type="hidden" name="postType" id="commentPostType" value="blog" />
          <input type="hidden" name="lang" id="commentLang" value="" />

          <p class="hp" hidden>
            <label>Don’t fill this out: <input name="bot-field" /></label>
          </p>

          <div class="comments-grid">
            <div class="form-row">
              <label for="c_name" data-i18n-key="comments.name">Jméno</label>
              <input id="c_name" name="name" type="text" required autocomplete="name"
                     placeholder="Tvoje jméno" data-i18n-placeholder="comments.namePh" />
            </div>

            <div class="form-row">
              <label for="c_email" data-i18n-key="comments.email">E-mail</label>
              <input id="c_email" name="email" type="email" required autocomplete="email"
                     placeholder="tvuj@email.cz" data-i18n-placeholder="comments.emailPh" />
              <small class="hint" data-i18n-key="comments.emailHint">E-mail se nezobrazuje veřejně.</small>
            </div>

            <div class="form-row">
              <label for="c_website" data-i18n-key="comments.website">Web (nepovinné)</label>
              <input id="c_website" name="website" type="url"
                     placeholder="https://tvoje-stranka.cz" data-i18n-placeholder="comments.websitePh" />
              <small class="hint" data-i18n-key="comments.websiteHint">Web se veřejně nezobrazuje.</small>
            </div>

            <div class="form-row form-row--full">
              <label for="c_comment" data-i18n-key="comments.comment">Komentář</label>
              <textarea id="c_comment" name="comment" rows="5" required
                        placeholder="Napiš svůj komentář…" data-i18n-placeholder="comments.commentPh"></textarea>
            </div>

            <div data-netlify-recaptcha="true"></div>

            <div class="form-actions">
              <button type="submit" class="btn-primary" data-i18n-key="comments.submit">Odeslat komentář</button>
              <p class="form-status" id="commentStatus" aria-live="polite"></p>
            </div>
          </div>
        </form>

        <div id="commentsList" class="comments-list" aria-live="polite"></div>
      </section>
      <!-- COMMENTS: end -->
    </div>
  </section>
</main>

<footer>
  <!-- ... footer ... -->
</footer>

<!-- blog-detail logika (ESM) -->
<script type="module" src="/src/blog-detail.js"></script>

<!-- Inline init pro komentáře: nastaví lang/postId/postType, načte a odesílá -->
<script>
  (function () {
    const qs = new URLSearchParams(location.search);
    const lang =
      (qs.get('lang') || document.documentElement.getAttribute('lang') || 'cs')
        .toLowerCase().split(/[-_]/)[0];
    document.getElementById('commentLang').value = lang;

    let postType = 'blog';
    let postId = qs.get('id') || location.pathname;
    document.getElementById('commentPostType').value = postType;
    document.getElementById('commentPostId').value = postId;

    const statusEl = document.getElementById('commentStatus');
    const listEl = document.getElementById('commentsList');

    const escape = (s='') =>
      String(s)
        .replace(/&/g, '&amp;').replace(/</g, '&lt;')
        .replace(/>/g, '&gt;').replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

    function fmtDate(iso) {
      try {
        const d = new Date(iso);
        return d.toLocaleString(lang, { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
      } catch { return iso; }
    }

    function renderComments(items) {
      if (!Array.isArray(items) || !items.length) {
        listEl.innerHTML = '<p class="comments-empty" data-i18n-key="comments.empty">Zatím žádné komentáře.</p>';
        return;
      }
      listEl.innerHTML = items.map(it => `
        <article class="comment-item" data-id="${escape(it.id)}">
          <header class="comment-head">
            <strong class="comment-author">${escape(it.name || 'Anonym')}</strong>
            <time class="comment-date" datetime="${escape(it.createdAt)}">${escape(fmtDate(it.createdAt))}</time>
          </header>
          <div class="comment-body"><p>${escape(it.comment).replace(/\n{2,}/g, '</p><p>').replace(/\n/g, '<br>')}</p></div>
        </article>
      `).join('');
    }

    async function loadComments() {
      try {
        const url = new URL('/.netlify/functions/get-comments', location.origin);
        url.searchParams.set('postId', postId);
        url.searchParams.set('postType', postType);
        url.searchParams.set('lang', lang);
        const r = await fetch(url.toString(), { headers: { 'Accept': 'application/json' } });
        const data = await r.json();
        renderComments(data.items || []);
      } catch (e) {
        listEl.innerHTML = '<p class="comments-error">Komentáře nelze načíst.</p>';
      }
    }

    loadComments();

    const form = document.getElementById('commentForm');
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      const fd = new FormData(form);
      if (!fd.get('form-name')) fd.set('form-name', 'site-comments');

      fetch('/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams(fd).toString()
      })
      .then(() => {
        statusEl.textContent = (lang === 'cs') ? 'Díky! Komentář byl odeslán.' : 'Thanks! Your comment was submitted.';
        form.reset();
        setTimeout(loadComments, 1200);
      })
      .catch(() => {
        statusEl.textContent = (lang === 'cs') ? 'Odeslání se nepodařilo.' : 'Submission failed.';
      });
    }, { passive: false });
  })();
</script>
</body>
</html>
